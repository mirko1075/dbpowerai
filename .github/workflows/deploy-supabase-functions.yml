name: Deploy Supabase Functions

on:
  pull_request:
    types: [closed]
    branches:
      - main
  push:
    branches:
      - main
    paths:
      - "supabase/functions/**"
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Node + Supabase CLI
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Login to Supabase
        run: supabase login "${{ secrets.SUPABASE_ACCESS_TOKEN }}"

      - name: Link project
        run: supabase link --project-ref "${{ secrets.SUPABASE_PROJECT_ID }}"

      - name: Deploy all functions
        run: supabase functions deploy --all
